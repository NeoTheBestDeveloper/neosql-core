#include <unistd.h>

#include "criterion/criterion.h"
#include "criterion/new/assert.h"

#include "nclib.h"

#include "database_driver/header.h"
#include "tests/utils.h"
#include "utils/os.h"

void header_serialise(const Header* header, u8* buf);
Header header_deserialise(u8*);

static u8 expected_serialised_header[] = {
    0x4e, 0x45, 0x4f, 0x53, 0x51, 0x4c, 0x0,  0x0,  0x0,  0x0,  0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x0,  0x20,
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x0,  0x0,  0x0,  0x0,
};

static u8 with_corrupted_size_serialised_header[] = {
    0x4e, 0x45, 0x4f, 0x53, 0x51, 0x4c, 0x0,  0x0,  0x0,  0x0,  0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x0,  0x20,
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
};

static u8 with_corrupted_magic_serialised_header[] = {
    0x4e, 0x34, 0x0,  0xff, 0x51, 0x4c, 0x0,  0x0,  0x0,  0x0,  0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x0,  0x20,
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x0,  0x0,  0x0,  0x0,
};

Test(TestHeader, test_header_serialisation)
{
    Header expected_header = DEFAULT_HEADER;
    u8 serialised_header[HEADER_SIZE] = { 0 };
    header_serialise(&expected_header, serialised_header);
    cr_assert_arr_eq(serialised_header, expected_serialised_header,
                     HEADER_SIZE);
}

Test(TestHeader, test_header_deserialisation)
{
    Header expected_header = DEFAULT_HEADER;
    const Header header = header_deserialise(expected_serialised_header);

    cr_assert(eq(u32, header.cached_pages_count,
                 expected_header.cached_pages_count));
    cr_assert(eq(u32, header.pages_count, expected_header.pages_count));
    cr_assert(addr_eq(header.first_table, expected_header.first_table));
    cr_assert(addr_eq(header.last_table, expected_header.last_table));
}

Test(TestHeader, test_header_successfull_read)
{
    i32 fd = open_db_file(TEST_DB_PATH);

    HeaderResult res = header_new(fd);

    cr_assert(eq(u32, res.status, HEADER_OK));

    Header header = res.header;
    cr_assert(eq(u32, header.cached_pages_count, DEFAULT_CACHED_PAGES_COUNT));
    cr_assert(eq(u32, header.pages_count, 2));
    cr_assert(addr_eq(header.first_table, (Addr) { 0, 0 }));
    cr_assert(
        addr_eq(header.last_table, (Addr) { .page_id = 0, .offset = 70 }));

    close(fd);
}

Test(TestHeader, test_header_successfull_write)
{
    WITH_TMP_FILE(tmp_fd)
    {
        Header header = DEFAULT_HEADER;
        header_write(&header, tmp_fd);

        u8 serialised_header[HEADER_SIZE];
        lseek(tmp_fd, 0, SEEK_SET);
        read(tmp_fd, serialised_header, HEADER_SIZE);

        cr_assert_arr_eq(serialised_header, expected_serialised_header,
                         HEADER_SIZE);
    }
}

Test(TestHeader, test_header_read_invalid_db_file_size)
{
    WITH_TMP_FILE(tmp_fd)
    {
        write(tmp_fd, with_corrupted_size_serialised_header,
              sizeof with_corrupted_size_serialised_header);

        HeaderResult res = header_new(tmp_fd);
        cr_assert(eq(u32, res.status, HEADER_FILE_INVALID_SIZE));
    }
}

Test(TestHeader, test_header_read_invalid_db_magic)
{
    WITH_TMP_FILE(tmp_fd)
    {
        write(tmp_fd, with_corrupted_magic_serialised_header,
              sizeof with_corrupted_magic_serialised_header);

        HeaderResult res = header_new(tmp_fd);
        cr_assert(eq(u32, res.status, HEADER_INVALID_MAGIC));
    }
}
