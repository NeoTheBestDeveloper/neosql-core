#include <stdlib.h>

#include "criterion/criterion.h"
#include "criterion/new/assert.h"

#include "nclib.h"

#include "database_driver/header.h"
#include "tests/utils.h"

u8* header_serialise(const Header*);
Header header_deserialise(u8*);

static const u8 expected_serialised_header[100] = {
    0x4e, 0x45, 0x4f, 0x53, 0x51, 0x4c, 0x0,  0x0,  0x0,  0x0,  0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x0,  0x20,
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x0,  0x0,  0x0,  0x0,
};
static const Header expected_header = DEFAULT_HEADER;

Test(TestHeader, test_header_serialisation)
{
    u8* serialised_header = header_serialise(&expected_header);
    cr_assert_arr_eq(serialised_header, expected_serialised_header,
                     HEADER_SIZE);

    free(serialised_header);
}

Test(TestHeader, test_header_deserialisation)
{
    const Header header = header_deserialise(expected_serialised_header);

    cr_assert(eq(u32, header.cached_pages_count,
                 expected_header.cached_pages_count));
    cr_assert(eq(u32, header.pages_count, expected_header.pages_count));
    cr_assert(addr_eq(header.first_table, expected_header.first_table));
    cr_assert(addr_eq(header.last_table, expected_header.last_table));
}

Test(TestHeader, test_header_successfull_read) { }
